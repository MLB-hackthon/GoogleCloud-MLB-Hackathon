name: CI/CD to Google Cloud

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: mlb-hackathon-448420
  REGION: us-central1

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Docker
      run: |
        # Clean up any existing Docker installations
        sudo apt-get remove -y docker docker-engine docker.io containerd runc
        sudo rm -rf /etc/apt/sources.list.d/docker*
        
        # Update package list
        sudo apt-get update
        
        # Install prerequisite packages
        sudo apt-get install -y \
          apt-transport-https \
          ca-certificates \
          curl \
          gnupg \
          lsb-release

        # Add Docker's official GPG key
        sudo install -m 0755 -d /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        sudo chmod a+r /etc/apt/keyrings/docker.gpg

        # Add Docker repository
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian stable" | \
          sudo tee /etc/apt/sources.list.d/docker.list

        # Install Docker
        sudo apt-get update
        sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

        # Configure Docker permissions
        sudo groupadd docker || true
        sudo usermod -aG docker $USER
        newgrp docker

    - name: Clean up old builds
      run: |
        # Remove old build artifacts
        rm -rf build/
        rm -rf node_modules/
        
        # Clean Docker images and containers
        sudo docker system prune -af
        
        # Clean up old Cloud Build artifacts
        gcloud container images list-tags gcr.io/${{ env.PROJECT_ID }}/mlb-app \
          --format='get(digest)' --filter='timestamp.datetime < -P30D' | \
        while read digest; do
          gcloud container images delete "gcr.io/${{ env.PROJECT_ID }}/mlb-app@${digest}" --quiet
        done || true

    - name: Google Auth
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'
        project_id: ${{ env.PROJECT_ID }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Submit Cloud Build
      run: |
        gcloud builds submit --config cloudbuild.yaml --project ${{ env.PROJECT_ID }} 